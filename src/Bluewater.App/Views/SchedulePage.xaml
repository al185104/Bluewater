<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Bluewater.App.ViewModels"
             xmlns:views="clr-namespace:Bluewater.App.Views"
             x:Class="Bluewater.App.Views.SchedulePage"
             Title="Schedules">
    <ContentPage.Resources>
        <ResourceDictionary>
            <GridItemsLayout x:Key="WeekGridLayout"
                             Orientation="Vertical"
                             Span="7"
                             HorizontalItemSpacing="1"
                             VerticalItemSpacing="1" />
            <Style x:Key="ScheduleCellBorderStyle"
                   TargetType="Border">
                <Setter Property="StrokeThickness"
                        Value="1" />
                <Setter Property="Stroke"
                        Value="{AppThemeBinding Light=#E0E0E0, Dark=#2A2A2A}" />
                <Setter Property="BackgroundColor"
                        Value="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}" />
                <Setter Property="Padding"
                        Value="8" />
            </Style>
            <Style x:Key="ScheduleHeaderBorderStyle"
                   TargetType="Border">
                <Setter Property="BackgroundColor"
                        Value="{AppThemeBinding Light={StaticResource AccentColor}, Dark=#1F5AA8}" />
                <Setter Property="Padding"
                        Value="12" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid>
        <Grid Padding="20,40"
              RowDefinitions="Auto,Auto,Auto,*"
              RowSpacing="16">
            <Grid ColumnDefinitions="*,Auto"
                  ColumnSpacing="12">
                <Label Text="Schedules"
                       Style="{StaticResource HeadingTextStyle}" />
                <HorizontalStackLayout Grid.Column="1"
                                       Spacing="10"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center">
                    <Button Text="Import"
                            Command="{Binding ImportSchedulesCommand}"
                            SemanticProperties.Hint="Import schedules from a CSV file" />
                </HorizontalStackLayout>
            </Grid>
            <Grid Grid.Row="1"
                  ColumnDefinitions="*,Auto"
                  ColumnSpacing="12"
                  VerticalOptions="Center">
                <HorizontalStackLayout Spacing="8"
                                       VerticalOptions="Center">
                    <Label Text="Charging"
                           Style="{StaticResource BodyTextStyle}"
                           FontAttributes="Bold"
                           VerticalOptions="Center" />
                    <Picker ItemsSource="{Binding Chargings}"
                            SelectedItem="{Binding SelectedCharging}"
                            ItemDisplayBinding="{Binding Name}"
                            Title="Select charging"
                            WidthRequest="220" />
                </HorizontalStackLayout>
                <HorizontalStackLayout Grid.Column="1"
                                       Spacing="8"
                                       HorizontalOptions="End"
                                       VerticalOptions="Center">
                    <Button Text="⟨"
                            WidthRequest="44"
                            Command="{Binding PreviousWeekCommand}"
                            SemanticProperties.Hint="Show the previous week" />
                    <Label Text="{Binding WeekRangeDisplay}"
                           Style="{StaticResource BodyTextStyle}"
                           FontAttributes="Bold"
                           VerticalOptions="Center"
                           HorizontalTextAlignment="Center" />
                    <Button Text="⟩"
                            WidthRequest="44"
                            Command="{Binding NextWeekCommand}"
                            SemanticProperties.Hint="Show the next week" />
                </HorizontalStackLayout>
            </Grid>
            <Label Grid.Row="2"
                   Grid.ColumnSpan="2"
                   Text="{Binding ImportStatusMessage}"
                   Style="{StaticResource BodyTextStyle}"
                   TextColor="{AppThemeBinding Light=#0A386E, Dark=#9CC4FF}"
                   IsVisible="{Binding HasImportStatusMessage}" />
            <Grid Grid.Row="3">
                <CollectionView ItemsSource="{Binding EmployeeSchedules}"
                                SelectionMode="None"
                                VerticalOptions="Fill"
                                Margin="0">
                    <CollectionView.Header>
                        <Border Style="{StaticResource ScheduleHeaderBorderStyle}"
                                StrokeShape="RoundRectangle 10 10 0 0">
                            <Grid ColumnDefinitions="2*,5*"
                                  ColumnSpacing="12">
                                <Label Text="Employee"
                                       TextColor="White"
                                       FontAttributes="Bold" />
                                <CollectionView Grid.Column="1"
                                                ItemsSource="{Binding WeekDays}"
                                                ItemsLayout="{StaticResource WeekGridLayout}"
                                                SelectionMode="None"
                                                HorizontalScrollBarVisibility="Never"
                                                VerticalScrollBarVisibility="Never">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="viewmodels:WeekDayHeaderViewModel">
                                            <Border BackgroundColor="Transparent"
                                                    Padding="4">
                                                <VerticalStackLayout Spacing="2"
                                                                      HorizontalOptions="Center">
                                                    <Label Text="{Binding DayName}"
                                                           TextColor="White"
                                                           FontAttributes="Bold"
                                                           HorizontalTextAlignment="Center" />
                                                    <Label Text="{Binding DateDisplay}"
                                                           TextColor="White"
                                                           FontSize="12"
                                                           HorizontalTextAlignment="Center" />
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </Grid>
                        </Border>
                    </CollectionView.Header>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="viewmodels:EmployeeWeeklyScheduleViewModel">
                            <Border StrokeThickness="0"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}">
                                <Grid ColumnDefinitions="2*,5*"
                                      Padding="20"
                                      ColumnSpacing="12">
                                    <VerticalStackLayout Spacing="2">
                                        <Label Text="{Binding Name}"
                                               FontAttributes="Bold"
                                               Style="{StaticResource BodyTextStyle}" />
                                        <Label Text="{Binding Section}"
                                               Style="{StaticResource CaptionTextStyle}"
                                               IsVisible="{Binding HasSection}" />
                                        <Label Text="{Binding BarcodeDisplay}"
                                               Style="{StaticResource CaptionTextStyle}"
                                               IsVisible="{Binding HasBarcode}" />
                                    </VerticalStackLayout>
                                    <CollectionView Grid.Column="1"
                                                    ItemsSource="{Binding Days}"
                                                    ItemsLayout="{StaticResource WeekGridLayout}"
                                                    SelectionMode="None"
                                                    HorizontalScrollBarVisibility="Never"
                                                    VerticalScrollBarVisibility="Never">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="viewmodels:EmployeeScheduleDayViewModel">
                                                <Border Style="{StaticResource ScheduleCellBorderStyle}">
                                                    <Grid>
                                                        <Picker ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type views:SchedulePage}}, Path=BindingContext.ShiftOptions}"
                                                                SelectedItem="{Binding SelectedShift}"
                                                                ItemDisplayBinding="{Binding DisplayName}"
                                                                HorizontalOptions="Fill"
                                                                IsEnabled="{Binding IsEnabled}"
                                                                Title="Select shift" />
                                                        <ActivityIndicator IsVisible="{Binding IsProcessing}"
                                                                           IsRunning="{Binding IsProcessing}"
                                                                           HorizontalOptions="Center"
                                                                           VerticalOptions="Center" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Spacing="8">
                            <Label Text="No schedules found"
                                   HorizontalTextAlignment="Center"
                                   FontAttributes="Bold" />
                            <Label Text="Select a charging and week to view employee schedules."
                                   FontSize="12"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
                <ActivityIndicator IsVisible="{Binding IsLoadingSchedules}"
                                   IsRunning="{Binding IsLoadingSchedules}"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
