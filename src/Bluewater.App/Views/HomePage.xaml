<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Bluewater.App.ViewModels"
             xmlns:controls="clr-namespace:Bluewater.App.Views.Controls"
             x:Class="Bluewater.App.Views.HomePage"
             Title="Dashboard">
    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="CardBorderStyle"
                   TargetType="Border">
                <Setter Property="StrokeShape"
                        Value="RoundRectangle 16" />
                <Setter Property="StrokeThickness"
                        Value="0" />
                <Setter Property="Padding"
                        Value="20" />
                <Setter Property="BackgroundColor"
                        Value="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="{AppThemeBinding Light=#1A000000, Dark=#66000000}"
                                Radius="12"
                                Opacity="0.6" />
                    </Setter.Value>
                </Setter>
            </Style>
            <Style x:Key="SectionTitleStyle"
                   TargetType="Label">
                <Setter Property="FontSize"
                        Value="18" />
                <Setter Property="FontAttributes"
                        Value="Bold" />
                <Setter Property="TextColor"
                        Value="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" />
            </Style>
            <Style x:Key="MutedLabelStyle"
                   TargetType="Label">
                <Setter Property="FontSize"
                        Value="12" />
                <Setter Property="TextColor"
                        Value="{AppThemeBinding Light=#6B7280, Dark=#94A3B8}" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>
    <RefreshView IsRefreshing="{Binding IsBusy}"
                 Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="24,20"
                                 Spacing="18">
                <Label Text="Workforce Insights"
                       FontSize="24"
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#0F172A, Dark=#F1F5F9}" />
                <Label Text="{Binding LastUpdatedDisplay, StringFormat='Last updated {0}'}"
                       Style="{StaticResource MutedLabelStyle}" />
                <Grid ColumnDefinitions="*,*"
                      RowDefinitions="Auto,Auto,Auto,Auto"
                      ColumnSpacing="18"
                      RowSpacing="18">
                    <Border Grid.ColumnSpan="2"
                            Style="{StaticResource CardBorderStyle}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Today's Attendance Summary"
                                   Style="{StaticResource SectionTitleStyle}" />
                            <controls:DonutChartView Segments="{Binding AttendanceSummarySegments}" />
                            <CollectionView ItemsSource="{Binding AttendanceSummarySegments}"
                                            SelectionMode="None"
                                            Margin="0,-6,0,0">
                                <CollectionView.EmptyView>
                                    <Label Text="No attendance data for today."
                                           Style="{StaticResource MutedLabelStyle}"
                                           HorizontalTextAlignment="Center" />
                                </CollectionView.EmptyView>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewModels:DashboardChartSegment">
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                                              Padding="0,6">
                                            <Frame WidthRequest="12"
                                                   HeightRequest="12"
                                                   CornerRadius="4"
                                                   BackgroundColor="{Binding Color}"
                                                   HasShadow="False"
                                                   Margin="0,0,12,0"
                                                   VerticalOptions="Center" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding Label}"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" />
                                            <Label Grid.Column="2"
                                                   Text="{Binding Value, StringFormat='{}{0:N0}'}"
                                                   TextColor="{AppThemeBinding Light=#6B7280, Dark=#94A3B8}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                    <Border Grid.Row="1"
                            Grid.Column="0"
                            Style="{StaticResource CardBorderStyle}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Weekly Attendance Trend"
                                   Style="{StaticResource SectionTitleStyle}" />
                            <controls:TrendLineChartView Points="{Binding WeeklyAttendanceTrend}"
                                                         LineColor="#2563EB" />
                            <Label Text="Employees present across the past 7 days."
                                   Style="{StaticResource MutedLabelStyle}" />
                        </VerticalStackLayout>
                    </Border>
                    <Border Grid.Row="1"
                            Grid.Column="1"
                            Style="{StaticResource CardBorderStyle}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Leave Type Distribution"
                                   Style="{StaticResource SectionTitleStyle}" />
                            <controls:PieChartView Segments="{Binding LeaveDistributionSegments}" />
                            <CollectionView ItemsSource="{Binding LeaveDistributionSegments}"
                                            SelectionMode="None"
                                            Margin="0,-6,0,0">
                                <CollectionView.EmptyView>
                                    <Label Text="No recent leave applications."
                                           Style="{StaticResource MutedLabelStyle}"
                                           HorizontalTextAlignment="Center" />
                                </CollectionView.EmptyView>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewModels:DashboardChartSegment">
                                        <Grid ColumnDefinitions="Auto,*,Auto"
                                              Padding="0,6">
                                            <Frame WidthRequest="12"
                                                   HeightRequest="12"
                                                   CornerRadius="4"
                                                   BackgroundColor="{Binding Color}"
                                                   HasShadow="False"
                                                   Margin="0,0,12,0"
                                                   VerticalOptions="Center" />
                                            <Label Grid.Column="1"
                                                   Text="{Binding Label}"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" />
                                            <Label Grid.Column="2"
                                                   Text="{Binding Value, StringFormat='{}{0:N1}'}"
                                                   TextColor="{AppThemeBinding Light=#6B7280, Dark=#94A3B8}" />
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                    <Border Grid.Row="2"
                            Grid.ColumnSpan="2"
                            Style="{StaticResource CardBorderStyle}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Top 5 Employees with Perfect Attendance"
                                   Style="{StaticResource SectionTitleStyle}" />
                            <CollectionView ItemsSource="{Binding PerfectAttendanceLeaders}"
                                            SelectionMode="None">
                                <CollectionView.EmptyView>
                                    <Label Text="No perfect attendance streaks recorded in the current window."
                                           Style="{StaticResource MutedLabelStyle}"
                                           HorizontalTextAlignment="Center" />
                                </CollectionView.EmptyView>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="viewModels:DashboardLeaderboardEntry">
                                        <Border StrokeShape="RoundRectangle 12"
                                                BackgroundColor="{AppThemeBinding Light=#F9FAFB, Dark=#111827}"
                                                Padding="14"
                                                Margin="0,4">
                                            <Grid ColumnDefinitions="Auto,*,Auto"
                                                  RowDefinitions="Auto,Auto"
                                                  ColumnSpacing="12"
                                                  RowSpacing="6">
                                                <Border StrokeShape="RoundRectangle 10"
                                                        BackgroundColor="#2563EB"
                                                        WidthRequest="32"
                                                        HeightRequest="32"
                                                        VerticalOptions="Start"
                                                        HorizontalOptions="Center">
                                                    <Label Text="{Binding Rank}"
                                                           TextColor="White"
                                                           FontAttributes="Bold"
                                                           HorizontalOptions="Center"
                                                           VerticalOptions="Center" />
                                                </Border>
                                                <Label Grid.Column="1"
                                                       Text="{Binding EmployeeName}"
                                                       FontAttributes="Bold"
                                                       FontSize="16"
                                                       TextColor="{AppThemeBinding Light=#111827, Dark=#E5E7EB}" />
                                                <Label Grid.Column="2"
                                                       Text="{Binding AttendanceRate, StringFormat='{}{0:P0}'}"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light=#2563EB, Dark=#60A5FA}"
                                                       HorizontalTextAlignment="End" />
                                                <StackLayout Grid.Column="1"
                                                            Grid.Row="1"
                                                            Orientation="Horizontal"
                                                            Spacing="12">
                                                    <Label Text="{Binding PerfectDays, StringFormat='Perfect days: {0}'}"
                                                           Style="{StaticResource MutedLabelStyle}" />
                                                    <Label Text="{Binding LateDays, StringFormat='Late: {0}'}"
                                                           Style="{StaticResource MutedLabelStyle}" />
                                                    <Label Text="{Binding Absences, StringFormat='Absences: {0}'}"
                                                           Style="{StaticResource MutedLabelStyle}" />
                                                </StackLayout>
                                                <Label Grid.Column="2"
                                                       Grid.Row="1"
                                                       Text="{Binding TotalTrackedDays, StringFormat='{0} days tracked'}"
                                                       HorizontalTextAlignment="End"
                                                       Style="{StaticResource MutedLabelStyle}" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Border>
                    <Border Grid.Row="3"
                            Grid.ColumnSpan="2"
                            Style="{StaticResource CardBorderStyle}">
                        <VerticalStackLayout Spacing="12">
                            <Label Text="Monthly Absences Trend"
                                   Style="{StaticResource SectionTitleStyle}" />
                            <controls:TrendLineChartView Points="{Binding MonthlyAbsenceTrend}"
                                                         LineColor="#DC2626" />
                            <Label Text="Absences recorded over the last 12 months."
                                   Style="{StaticResource MutedLabelStyle}" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
