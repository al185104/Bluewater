@page "/attendance/details/{EmpId:guid}/{SearchDate:datetime}"
@using Bluewater.Server.Global;
@using Bluewater.UseCases.Attendances
@using Bluewater.UseCases.Attendances.Create
@using Bluewater.UseCases.Attendances.Get
@using Bluewater.UseCases.Attendances.List
@using Bluewater.UseCases.Attendances.Update
@using Bluewater.UseCases.Employees
@using Bluewater.UseCases.Schedules.Create
@using Bluewater.UseCases.Schedules.Update
@using Bluewater.UseCases.Timesheets;
@using Bluewater.UseCases.Shifts;
@using Bluewater.UseCases.Timesheets.Create
@using Bluewater.UseCases.Timesheets.Update
@using MediatR
@rendermode InteractiveServer

@inject IServiceScopeFactory ServiceScopeFactory
@inject IMediator Mediator
@inject IGlobalService GlobalService;
@inject IDialogService DialogService

<FluentGrid>
    <FluentGridItem xs="4">
        <FluentStack HorizontalGap="20" HorizontalAlignment="HorizontalAlignment.Left" VerticalAlignment="VerticalAlignment.Center">
            <FluentButton IconStart="@(new Icons.Regular.Size16.ChevronLeft())" Appearance="Appearance.Accent" OnClick="@(async() => await LoadAttendanceAsync(SearchDate = SearchDate.AddDays(-15)))"/>
            <h5 style="margin: 0; vertical-align: middle;">from @startDate.ToString("MMM-dd") to @endDate.ToString("MMM-dd")</h5>
            <FluentButton IconStart="@(new Icons.Regular.Size16.ChevronRight())" Appearance="Appearance.Accent" OnClick="@(async() => await LoadAttendanceAsync(SearchDate = SearchDate.AddDays(15)))"/>
        </FluentStack>
    </FluentGridItem>
    <FluentGridItem xs="8">
        <FluentStack HorizontalGap="20" HorizontalAlignment="HorizontalAlignment.Right" VerticalAlignment="VerticalAlignment.Center">
            <FluentLabel Style="margin-top: 0px;"><strong>Employee: @($"{Employee?.LastName}, {Employee?.FirstName}")</strong></FluentLabel>
            <FluentLabel>Department: @Employee?.Department</FluentLabel>
            <FluentLabel>Section: @Employee?.Section</FluentLabel>
            <FluentLabel Style="margin-bottom: 0px;">Charging: @Employee?.Charging</FluentLabel>
            <FluentButton IconStart="@(new Icons.Regular.Size16.Save())" OnClick="@(async() => await SubmitAllAttendanceAsync())" Appearance="Appearance.Accent">Save & Submit</FluentButton>
        </FluentStack>
    </FluentGridItem>
</FluentGrid>

<FluentDataGrid Items="@EmployeeAttendance" TGridItem="AttendanceDTO"
    GridTemplateColumns="1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 0.8fr 0.8fr 0.8fr 0.6fr">
    <PropertyColumn Title="Date" Property="@(p => p.EntryDate)" Format="MMM-dd" Sortable="true"/>
    <PropertyColumn Title="Day" Property="@(p => p.EntryDate)" Format="dddd"/>
    <TemplateColumn Title="Shift" Align="@Align.Center">
        <FluentButton IconStart="@(new Icons.Regular.Size16.Edit())" OnClick="@(async() => await OnShiftButtonClickAsync(context))" Style="width: 100px" Disabled=@context.IsLocked>
            @(context.Shift?.Name ?? "No shift")
        </FluentButton>
    </TemplateColumn>
    <PropertyColumn Title="Start time" Property="@(p => p.Shift != null ? p.Shift.ShiftStartTime : default)" Format="hh:mm tt" />
    <PropertyColumn Title="Break start" Property="@(p => p.Shift != null ? p.Shift.ShiftBreakTime : default)" Format="hh:mm tt" />
    <PropertyColumn Title="Break end" Property="@(p => p.Shift != null ? p.Shift.ShiftBreakEndTime : default)" Format="hh:mm tt" />        
    <PropertyColumn Title="End time" Property="@(p => p.Shift != null ? p.Shift.ShiftEndTime : default)" Format="hh:mm tt" />
    <TemplateColumn Title="In #1" Align="@Align.Center">
        <FluentTimePicker Value="@(context.Timesheet?.TimeIn1 ?? DateTime.MinValue)" ValueChanged="@(e => context.Timesheet!.TimeIn1 = e)" Format="hh:mm tt" Disabled=@context.IsLocked/>
    </TemplateColumn>
    <TemplateColumn Title="Out #1" Align="@Align.Center">
        <FluentTimePicker Value="@(context.Timesheet?.TimeOut1 ?? DateTime.MinValue)" ValueChanged="@(e => context.Timesheet!.TimeOut1 = e)" Format="hh:mm tt" Disabled=@context.IsLocked/>        
    </TemplateColumn>
    <TemplateColumn Title="In #2" Align="@Align.Center">
        <FluentTimePicker Value="@(context.Timesheet?.TimeIn2 ?? DateTime.MinValue)" ValueChanged="@(e => context.Timesheet!.TimeIn2 = e)" Format="hh:mm tt" Disabled=@context.IsLocked/>        
    </TemplateColumn>
    <TemplateColumn Title="Out #2" Align="@Align.Center">
        <FluentTimePicker Value="@(context.Timesheet?.TimeOut2 ?? DateTime.MinValue)" ValueChanged="@(e => context.Timesheet!.TimeOut2 = e)" Format="hh:mm tt" Disabled=@context.IsLocked/>        
    </TemplateColumn>
    <PropertyColumn Title="Work" Property="@(p => p.WorkHrs)" />
    <PropertyColumn Title="Late" Property="@(p => p.LateHrs)" />
    <PropertyColumn Title="Under" Property="@(p => p.UnderHrs)" />
    <PropertyColumn Title="Overbreak" Property="@(p => p.OverbreakHrs)" />
    <TemplateColumn Title="Action">
        <FluentButton IconStart="@(new Icons.Regular.Size16.ArrowSync())" OnClick="@(async() => await UpdateAttendanceAsync(context))" Appearance="Appearance.Accent" Disabled=@context.IsLocked/>
    </TemplateColumn>    
</FluentDataGrid>


@if (isBusy)
{
    <div class="overlay">
        <FluentProgressRing />
    </div>
}

<FluentDialogProvider/>

@code {

    [Parameter]
    public Guid EmpId { get; set; }

    [Parameter]
    public DateTime SearchDate { get; set; }
    private bool isBusy = false;
    private DateOnly startDate, endDate;
    private IQueryable<AttendanceDTO> EmployeeAttendance = default!;
    private EmployeeDTO Employee = default!;

    protected override async Task OnParametersSetAsync()
    {
        List<Task> tasks = new List<Task>{
            LoadAttendanceAsync(SearchDate),
            LoadEmployeeAsync(EmpId)
        };
        await Task.WhenAll(tasks);
    }

    private async Task LoadEmployeeAsync(Guid id) {
        try {
            using (var scope = ServiceScopeFactory.CreateScope())
            {
                var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                var result = await mediator.Send(new GetEmployeeQuery(id));
                if (result.IsSuccess)
                    Employee = result.Value;
            }
        }
        catch(Exception)
        {
            throw;
        }
    }

    private async Task LoadAttendanceAsync(DateTime date)
    {
        try {
            isBusy = true;

            using (var scope = ServiceScopeFactory.CreateScope())
            {
                var (_startDate, _endDate) = GlobalService.GetStartDateAndEndDateOfPayslip(DateOnly.FromDateTime(date));
                startDate = _startDate;
                endDate = _endDate;
                var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                var result = await mediator.Send(new ListAttendanceQuery(null, null, EmpId, _startDate, _endDate));
                if (result.IsSuccess) {
                    EmployeeAttendance = result.Value.AsQueryable();
                }
            }      
        }
        catch(Exception)
        {
            throw;
        }   
        finally{
            isBusy = false;
        }
    }

    private async Task OnShiftButtonClickAsync(AttendanceDTO context)
    {
        DialogParameters parameters = new()
        {
            Title = "Select shift",
            PrimaryAction = "Yes",
            PrimaryActionEnabled = true,
            SecondaryAction = "No",
            Width = "600px",
            Height = "500px",
            Modal = true,
        };

        IDialogReference dialog = await DialogService.ShowDialogAsync<ShiftDialog>(context!.Shift ?? default!, parameters);
        DialogResult? result = await dialog.Result;

        if (!result.Cancelled && result.Data != null) {
            var item = EmployeeAttendance.FirstOrDefault(x => x.EntryDate == context.EntryDate);
            item!.Shift = (ShiftDTO)result.Data;
            item!.ShiftId = item.Shift.Id;

            if(item.ShiftId != null && item.EntryDate != null){
                // update schedule
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                    //Guid EmployeeId, Guid ShiftId, DateOnly ScheduleDate, bool IsDefault
                    var scheduleResult = await mediator.Send(new CreateScheduleCommand(item.EmployeeId, item!.ShiftId ?? Guid.Empty, item!.EntryDate ?? DateOnly.MinValue, false));
                }
            }
        }
    }

    private async Task UpdateAttendanceAsync(AttendanceDTO attendance) {
        try {
            // check first if there's timesheet input
            if(attendance.Timesheet == null || attendance.TimesheetId == Guid.Empty) {
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                    var result = await mediator.Send(new CreateTimesheetCommand(attendance.EmployeeId, attendance.Timesheet!.TimeIn1, attendance.Timesheet!.TimeOut1, attendance.Timesheet!.TimeIn2, attendance.Timesheet!.TimeOut2, attendance.EntryDate));
                    if (result.IsSuccess)
                        attendance.TimesheetId = result.Value;
                }
            }
            else {
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                    var result = await mediator.Send(new UpdateTimesheetCommand(attendance.TimesheetId ?? Guid.Empty, attendance.EmployeeId, attendance.Timesheet!.TimeIn1, attendance.Timesheet!.TimeOut1, attendance.Timesheet!.TimeIn2, attendance.Timesheet!.TimeOut2, attendance.EntryDate, false));
                }
            }

            if(attendance.ShiftId == null || attendance.ShiftId == Guid.Empty) {
                await DialogService.ShowWarningAsync("Timesheet successfully saved but no shift selected. Please select a shift.", "Warning");
                return;
            }

            // if timesheetId is null, create attendance
            if(attendance.Id == Guid.Empty) {
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                    var result = await mediator.Send(new CreateAttendanceCommand(attendance.EmployeeId, attendance.ShiftId, attendance.TimesheetId, attendance.LeaveId, attendance.EntryDate, null, null, null, null, null));
                    if (result.IsSuccess)
                        await LoadAttendanceAsync(SearchDate);
                }
            }
            else {
                using (var scope = ServiceScopeFactory.CreateScope())
                {
                    var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                    var result = await mediator.Send(new UpdateAttendanceCommand(attendance.EmployeeId, attendance.ShiftId, attendance.TimesheetId, attendance.LeaveId, attendance.EntryDate));
                    if (result.IsSuccess)
                        await LoadAttendanceAsync(SearchDate);
                }
            }
        }
        catch(Exception)
        {
            throw;
        }
    }

    private async Task SubmitAllAttendanceAsync()
    {
        try {

            var dialog = await DialogService.ShowConfirmationAsync($"Are you sure you want to Save and Submit this attendance sheet? Please note that you won't be able to edit after submission.", "Yes", "No", "Save and Submit");
            var conf = await dialog.Result;
            if (conf.Cancelled) return;

            isBusy = true;

            foreach(var attendance in EmployeeAttendance)
            {
                if(attendance.Shift == null || attendance.ShiftId == null || attendance.ShiftId == Guid.Empty)
                    continue;

                if(attendance.Id == Guid.Empty) { // create attendance
                    using (var scope = ServiceScopeFactory.CreateScope())
                    {
                        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                        var result = await mediator.Send(new CreateAttendanceCommand(attendance.EmployeeId, attendance.ShiftId, attendance.TimesheetId, attendance.LeaveId, attendance.EntryDate, null, null, null, null, null, IsLocked: true));
                        if (!result.IsSuccess)
                            break;
                    }
                }
                else { // update
                    using (var scope = ServiceScopeFactory.CreateScope())
                    {
                        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
                        var result = await mediator.Send(new UpdateAttendanceCommand(attendance.EmployeeId, attendance.ShiftId, attendance.TimesheetId, attendance.LeaveId, attendance.EntryDate, IsLocked: true));
                        if (!result.IsSuccess)
                            break;
                    }
                }
            }

            await LoadAttendanceAsync(SearchDate);
        }
        catch(Exception)
        {
            throw;
        }
        finally {
            isBusy = false;
        }
    }
}
